---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Clients">
    <main class="space-y-8" x-data="clientsManager">
        <!-- Header -->
        <header
            class="flex justify-between items-center border-b border-white/10 pb-6 relative"
        >
            <div class="cross-marker -bottom-[5px] -left-[5px]"></div>
            <div class="cross-marker -bottom-[5px] -right-[5px]"></div>

            <h1
                class="text-3xl font-bold tracking-tighter uppercase relative z-10"
                x-text="$t('clients')"
            >
                Clients
            </h1>

            <div class="flex items-center gap-3">
                <select
                    x-model="filterStatus"
                    @change="loadClients()"
                    class="bg-brand-panel border border-white/10 text-xs font-mono text-white/70 px-3 py-1.5 focus:border-brand-purple/50 focus:outline-none"
                >
                    <option value="">All</option>
                    <option value="PENDING">Pending</option>
                    <option value="READY" selected>Ready</option>
                    <option value="ATTENDED">Attended</option>
                </select>

                <span
                    class="text-xs font-mono text-gray-500"
                    x-text="`${clients.length} ${$t('clients').toLowerCase()}`"
                ></span>
            </div>
        </header>

        <!-- Loading -->
        <template x-if="loading">
            <div class="flex items-center justify-center py-16">
                <div class="w-6 h-6 border-2 border-brand-purple border-t-transparent rounded-full animate-spin"></div>
            </div>
        </template>

        <!-- Empty State -->
        <template x-if="!loading && clients.length === 0">
            <div class="text-center py-16">
                <p
                    class="text-gray-500 font-mono text-sm"
                    x-text="$t('no_clients')"
                ></p>
            </div>
        </template>

        <!-- Clients Table -->
        <div
            x-show="!loading && clients.length > 0"
            class="overflow-x-auto"
        >
            <table class="w-full text-left">
                <thead>
                    <tr class="border-b border-white/10 text-[10px] text-gray-500 font-mono uppercase tracking-widest">
                        <th class="py-3 px-4" x-text="$t('client_name')">Name</th>
                        <th class="py-3 px-4">CURP</th>
                        <th class="py-3 px-4" x-text="$t('phone')">Phone</th>
                        <th class="py-3 px-4" x-text="$t('email')">Email</th>
                        <th class="py-3 px-4">Bot</th>
                        <th class="py-3 px-4" x-text="$t('status')">Status</th>
                        <th class="py-3 px-4" x-text="$t('date')">Date</th>
                        <th class="py-3 px-4"></th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="client in clients" :key="client.id">
                        <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors">
                            <td class="py-3 px-4 text-sm font-mono" x-text="client.name || '—'"></td>
                            <td class="py-3 px-4 text-xs font-mono text-gray-400" x-text="client.curp || '—'"></td>
                            <td class="py-3 px-4 text-xs font-mono text-gray-400" x-text="client.phone || '—'"></td>
                            <td class="py-3 px-4 text-xs font-mono text-gray-400" x-text="client.email || '—'"></td>
                            <td class="py-3 px-4 text-xs font-mono text-brand-purple" x-text="client.bot?.name || '—'"></td>
                            <td class="py-3 px-4">
                                <span
                                    class="px-2 py-0.5 text-[10px] font-mono uppercase tracking-wider border"
                                    :class="{
                                        'text-yellow-400 border-yellow-500/30 bg-yellow-500/10': client.status === 'PENDING',
                                        'text-green-400 border-green-500/30 bg-green-500/10': client.status === 'READY',
                                        'text-gray-400 border-gray-500/30 bg-gray-500/10': client.status === 'ATTENDED'
                                    }"
                                    x-text="client.status"
                                ></span>
                            </td>
                            <td class="py-3 px-4 text-[10px] font-mono text-gray-500" x-text="new Date(client.createdAt).toLocaleDateString()"></td>
                            <td class="py-3 px-4">
                                <div class="flex gap-2">
                                    <!-- Mark as READY -->
                                    <template x-if="client.status === 'PENDING'">
                                        <button
                                            @click="updateStatus(client.id, 'READY')"
                                            class="text-[10px] font-mono text-green-400 hover:text-green-300 border border-green-500/30 px-2 py-0.5 hover:bg-green-500/10 transition-colors"
                                            x-text="$t('mark_ready')"
                                        ></button>
                                    </template>

                                    <!-- Mark as ATTENDED -->
                                    <template x-if="client.status === 'READY'">
                                        <button
                                            @click="updateStatus(client.id, 'ATTENDED')"
                                            class="text-[10px] font-mono text-blue-400 hover:text-blue-300 border border-blue-500/30 px-2 py-0.5 hover:bg-blue-500/10 transition-colors"
                                            x-text="$t('mark_attended')"
                                        ></button>
                                    </template>

                                    <!-- Reset to PENDING (re-enable AI) -->
                                    <template x-if="client.status === 'READY' || client.status === 'ATTENDED'">
                                        <button
                                            @click="updateStatus(client.id, 'PENDING')"
                                            class="text-[10px] font-mono text-yellow-400 hover:text-yellow-300 border border-yellow-500/30 px-2 py-0.5 hover:bg-yellow-500/10 transition-colors"
                                            x-text="$t('reactivate_ai')"
                                        ></button>
                                    </template>

                                    <!-- Delete -->
                                    <button
                                        @click="deleteClient(client.id)"
                                        class="text-[10px] font-mono text-red-400 hover:text-red-300 border border-red-500/30 px-2 py-0.5 hover:bg-red-500/10 transition-colors"
                                    >
                                        ✕
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Toast -->
        <div
            x-show="toast"
            x-transition.opacity.duration.300ms
            class="fixed bottom-6 right-6 bg-green-500/20 border border-green-500/30 text-green-400 px-4 py-2 text-xs font-mono z-50"
            style="display: none;"
            x-text="toast"
        ></div>
    </main>
</Layout>

<script>
    declare const Alpine: any;
    import { ApiClient } from "../lib/api";

    document.addEventListener("alpine:init", () => {
        Alpine.data("clientsManager", () => ({
            clients: [] as any[],
            loading: true,
            filterStatus: "READY",
            toast: "",

            async init() {
                await this.loadClients();
            },

            async loadClients() {
                this.loading = true;
                try {
                    const params = new URLSearchParams();
                    if (this.filterStatus) params.set("status", this.filterStatus);
                    const result = await ApiClient.get(`/clients?${params.toString()}`);
                    this.clients = result.clients || [];
                } catch (e) {
                    console.error("Failed to load clients:", e);
                } finally {
                    this.loading = false;
                }
            },

            async updateStatus(id: string, status: string) {
                try {
                    await ApiClient.patch(`/clients/${id}`, { status });
                    await this.loadClients();
                    this.showToast("Updated");
                } catch (e) {
                    console.error("Update failed:", e);
                }
            },

            async deleteClient(id: string) {
                // @ts-ignore
                if (!confirm(this.$t("delete_confirm") || "Delete?")) return;
                try {
                    await ApiClient.delete(`/clients/${id}`);
                    await this.loadClients();
                    this.showToast("Deleted");
                } catch (e) {
                    console.error("Delete failed:", e);
                }
            },

            showToast(msg: string) {
                this.toast = msg;
                setTimeout(() => { this.toast = ""; }, 2000);
            },
        }));
    });
</script>
